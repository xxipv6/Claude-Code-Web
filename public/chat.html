<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code - Standalone</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    ::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }

    /* Smooth transitions for everything */
    * {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }

    /* Disable transition for specific elements */
    input, textarea, .no-transition, .diff-add, .diff-remove {
      transition: none !important;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-fadeIn-staggered-1 {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0ms forwards;
      opacity: 0;
    }

    .animate-fadeIn-staggered-2 {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) 50ms forwards;
      opacity: 0;
    }

    .animate-fadeIn-staggered-3 {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) 100ms forwards;
      opacity: 0;
    }

    .animate-slideInLeft {
      animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-slideInRight {
      animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-scaleIn {
      animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Message animation */
    .message-user {
      animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .message-assistant {
      animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* VSCode-style Tool Use Card */
    .tool-use-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-left: 3px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 8px 0;
      backdrop-filter: blur(10px);
    }

    .tool-use-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 13px;
      color: #60a5fa;
    }

    .tool-use-icon {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 4px;
      font-size: 10px;
      color: white;
      font-weight: bold;
    }

    .tool-use-id {
      font-size: 11px;
      color: #9ca3af;
      font-family: 'Fira Code', monospace;
    }

    .tool-use-params {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
      font-family: 'Fira Code', 'Consolas', monospace;
      overflow-x: auto;
    }

    .tool-param-key {
      color: #60a5fa;
    }

    .tool-param-string {
      color: #34d399;
    }

    .tool-param-number {
      color: #fbbf24;
    }

    /* VSCode-style Tool Result Card */
    .tool-result-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 8px 0;
    }

    .tool-result-card.error {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .tool-result-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
    }

    .tool-result-content {
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .tool-result-content.terminal {
      background: #0d0d0d;
      border-radius: 6px;
      padding: 10px;
      color: #d4d4d4;
    }

    /* VSCode-style Code Diff */
    .diff-container {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      margin: 8px 0;
      overflow: hidden;
    }

    .diff-header {
      background: #2d2d2d;
      padding: 6px 12px;
      font-size: 11px;
      color: #9ca3af;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .diff-file-path {
      color: #60a5fa;
      font-family: 'Fira Code', monospace;
    }

    .diff-content {
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.5;
      overflow-x: auto;
    }

    .diff-line {
      display: flex;
      padding: 2px 12px;
    }

    .diff-line-number {
      width: 50px;
      flex-shrink: 0;
      color: #6b7280;
      text-align: right;
      padding-right: 16px;
      user-select: none;
    }

    .diff-line-content {
      flex: 1;
      white-space: pre;
    }

    .diff-add {
      background: rgba(34, 197, 94, 0.15);
    }

    .diff-add .diff-line-content {
      color: #4ade80;
    }

    .diff-remove {
      background: rgba(239, 68, 68, 0.15);
    }

    .diff-remove .diff-line-content {
      color: #f87171;
    }

    .diff-hunk {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      font-weight: 600;
    }

    .diff-context {
      color: #d4d4d4;
    }

    /* Inline code */
    .inline-code {
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    /* Code block */
    .code-block {
      background: #0d0d0d;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      margin: 8px 0;
      overflow: hidden;
    }

    .code-header {
      background: #1e1e1e;
      padding: 6px 12px;
      font-size: 11px;
      color: #9ca3af;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .code-lang {
      font-family: 'Fira Code', monospace;
      text-transform: uppercase;
      font-weight: 600;
    }

    .code-content {
      padding: 12px;
      overflow-x: auto;
    }

    .code-content pre {
      margin: 0;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    .code-content code {
      font-family: inherit;
    }

    /* Message content styling */
    .message-content p {
      margin: 6px 0;
      line-height: 1.6;
    }

    .message-content ul, .message-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin: 4px 0;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(
        90deg,
        #1f2937 0%,
        #374151 20%,
        #1f2937 40%,
        #1f2937 100%
      );
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear;
    }

    /* Smooth scroll behavior */
    .smooth-scroll {
      scroll-behavior: smooth;
    }

    /* Session item hover effect */
    .session-item {
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .session-item:hover {
      transform: translateX(4px);
    }

    /* Streaming text animation */
    .streaming-text {
      position: relative;
    }

    .streaming-text::after {
      content: 'â–‹';
      display: inline-block;
      margin-left: 2px;
      animation: blink 1s step-end infinite;
      color: #60a5fa;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Text content styling */
    .text-content {
      line-height: 1.6;
    }

    .text-content p {
      margin: 6px 0;
    }
  </style>
</head>
<body class="bg-gray-950 text-gray-200 h-screen overflow-hidden">
  <div id="app" class="flex h-full">
    <!-- Sidebar -->
    <div id="sidebar" class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-gray-800 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">
            CC
          </div>
          <h2 class="font-semibold text-gray-100">Claude Code</h2>
        </div>
        <button id="new-chat-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-all duration-200 flex items-center gap-1.5 shadow-lg shadow-blue-900/20">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          æ–°å¯¹è¯
        </button>
      </div>

      <!-- å½“å‰é¡¹ç›®æ ‡é¢˜ -->
      <div id="project-title" class="px-4 py-2 border-b border-gray-800">
        <div class="text-xs text-gray-500 font-medium">ä¼šè¯å†å²</div>
      </div>

      <!-- Sessions List -->
      <div id="sessions-list" class="flex-1 overflow-y-auto p-2 space-y-1">
        <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>

      <!-- Sidebar Footer -->
      <div class="p-3 border-t border-gray-800 text-xs text-gray-500 text-center">
        ç‹¬ç«‹è¿è¡Œç‰ˆæœ¬
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <div class="h-14 bg-gray-900/50 backdrop-blur border-b border-gray-800 flex items-center px-6 flex-shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="connection-dot"></div>
          <span class="text-sm text-gray-400" id="status-text">è¿æ¥ä¸­...</span>
        </div>
        <div class="ml-auto flex items-center gap-3">
          <!-- é¡¹ç›®é€‰æ‹©å™¨ -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500">é¡¹ç›®:</span>
            <select id="project-selector" class="bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500 cursor-pointer">
              <option value="">æ— é¡¹ç›®</option>
            </select>
            <button id="create-project-btn" class="p-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg transition-colors" title="åˆ›å»ºæ–°é¡¹ç›®">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
            </button>
            <button id="manage-projects-btn" class="p-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg transition-colors" title="ç®¡ç†é¡¹ç›®">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- API Warning Banner -->
      <div id="api-warning" class="hidden bg-red-900/30 border-b border-red-800/50 p-3 px-6 flex items-center justify-between gap-4">
        <div class="text-sm text-red-300 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          <span><strong>API Key æœªé…ç½®</strong> - å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿå“åº”ã€‚è¯·é…ç½® API Keyã€‚</span>
        </div>
        <button onclick="dismissApiWarning()" class="px-3 py-1.5 bg-red-700 hover:bg-red-600 text-white text-sm rounded-lg transition-colors">
          çŸ¥é“äº†
        </button>
      </div>

      <!-- Config Info Banner -->
      <div id="config-info" class="hidden bg-emerald-900/30 border-b border-emerald-800/50 p-2 px-6 flex items-center justify-center gap-2">
        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-xs text-emerald-300">ä½¿ç”¨é…ç½®: <strong id="config-provider">åŠ è½½ä¸­...</strong></span>
      </div>

      <!-- Chat Container -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4 smooth-scroll">
        <!-- Welcome Message -->
        <div class="welcome-message flex flex-col items-center justify-center h-full text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-6 shadow-lg shadow-orange-900/30">
            CC
          </div>
          <h2 class="text-2xl font-bold text-gray-100 mb-2">æ¬¢è¿ä½¿ç”¨ Claude Code</h2>
          <p class="text-gray-400 mb-1">ç‹¬ç«‹è¿è¡Œçš„ AI ç¼–ç¨‹åŠ©æ‰‹</p>
          <p class="text-sm text-gray-500 mt-4">è¯•è¯•å‘é€ <code class="px-2 py-1 bg-gray-800 rounded text-emerald-400">/help</code> æŸ¥çœ‹å¯ç”¨å‘½ä»¤</p>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-800 bg-gray-900/30 backdrop-blur p-4">
        <div class="max-w-4xl mx-auto">
          <div class="flex gap-3 items-end">
            <div class="flex-1 relative">
              <textarea
                id="message-input"
                placeholder="è¾“å…¥æ¶ˆæ¯... (æ”¯æŒ /help, /commit ç­‰å‘½ä»¤)"
                rows="1"
                class="w-full bg-gray-800 border border-gray-700 hover:border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-xl px-4 py-3 pr-12 text-sm resize-none outline-none transition-all placeholder-gray-500 text-gray-200"
                style="min-height: 44px; max-height: 200px;"
              ></textarea>
            </div>
            <button id="send-button" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium rounded-xl transition-all duration-200 shadow-lg shadow-blue-900/20 flex items-center gap-2">
              <span>å‘é€</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            </button>
            <button id="stop-button" class="hidden px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-xl transition-all duration-200 shadow-lg shadow-red-900/20 flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
              </svg>
              <span>åœæ­¢</span>
            </button>
          </div>
          <div id="slash-hint" class="text-center mt-2">
            <span class="text-xs text-gray-500">å¯ç”¨å‘½ä»¤:</span>
            <span class="inline-flex items-center gap-1 ml-2">
              <kbd class="px-1.5 py-0.5 bg-gray-800 rounded text-xs text-gray-400">/help</kbd>
              <kbd class="px-1.5 py-0.5 bg-gray-800 rounded text-xs text-gray-400">/commit</kbd>
              <kbd class="px-1.5 py-0.5 bg-gray-800 rounded text-xs text-gray-400">/test</kbd>
              <kbd class="px-1.5 py-0.5 bg-gray-800 rounded text-xs text-gray-400">/build</kbd>
              <kbd class="px-1.5 py-0.5 bg-gray-800 rounded text-xs text-gray-400">/plan</kbd>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–è¯­æ³•é«˜äº®
    hljs.highlightAll();

    // çŠ¶æ€ç®¡ç†
    const state = {
      sessionId: null,
      connected: false,
      eventSource: null,
      apiKeyConfigured: false,
      configLoaded: false,
      baseUrl: '',
      messageHistory: [],
      sessionsList: [],
      // é¡¹ç›®ç®¡ç†
      projectsList: [],
      currentProjectId: null,
      // æµå¼æ¶ˆæ¯è¿½è¸ª
      streamingMessages: new Map(), // messageId -> messageElement
      currentMessageId: null,
      currentTextElement: null,
      // ä»»åŠ¡è¿è¡ŒçŠ¶æ€
      isTaskRunning: false,
      // SSE è¿æ¥é”ï¼ˆé˜²æ­¢é‡å¤è¿æ¥ï¼‰
      connectingLock: false
    };

    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const projectSelector = document.getElementById('project-selector');
    const createProjectBtn = document.getElementById('create-project-btn');
    const manageProjectsBtn = document.getElementById('manage-projects-btn');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const statusDot = document.getElementById('connection-dot');
    const statusText = document.getElementById('status-text');
    const apiWarning = document.getElementById('api-warning');
    const configInfo = document.getElementById('config-info');
    const configProvider = document.getElementById('config-provider');
    const sessionsListEl = document.getElementById('sessions-list');
    const newChatBtn = document.getElementById('new-chat-btn');

    // ==================== VSCode-style æ¸²æŸ“å‡½æ•° ====================

    /**
     * æ¸²æŸ“ Tool Use å¡ç‰‡
     */
    function renderToolUse(toolUse) {
      const card = document.createElement('div');
      card.className = 'tool-use-card';

      // è·å–å·¥å…·å›¾æ ‡
      const icon = getToolIcon(toolUse.name);

      // Header
      const header = document.createElement('div');
      header.className = 'tool-use-header';
      header.innerHTML = `
        <div class="tool-use-icon">${icon}</div>
        <span>${toolUse.name}</span>
        <span class="tool-use-id">${toolUse.id}</span>
      `;

      // Parameters
      const params = document.createElement('div');
      params.className = 'tool-use-params';
      params.innerHTML = formatToolParams(toolUse.input);

      card.appendChild(header);
      card.appendChild(params);

      return card;
    }

    /**
     * æ¸²æŸ“ Tool Result å¡ç‰‡
     */
    function renderToolResult(toolResult) {
      const card = document.createElement('div');
      const isError = toolResult.error || toolResult.content?.toLowerCase().includes('error');
      card.className = `tool-result-card ${isError ? 'error' : ''}`;

      // Header
      const header = document.createElement('div');
      header.className = 'tool-result-header';
      header.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isError ? 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"></path>
        </svg>
        <span>${toolResult.tool_use_id ? 'ç»“æœ: ' + toolResult.tool_use_id.substring(0, 20) + '...' : 'Tool Result'}</span>
      `;

      // Content
      const content = document.createElement('div');
      content.className = `tool-result-content ${isTerminalOutput(toolResult.content) ? 'terminal' : ''}`;
      content.textContent = toolResult.content || '';

      card.appendChild(header);
      card.appendChild(content);

      return card;
    }

    /**
     * æ¸²æŸ“ä»£ç å·®å¼‚
     */
    function renderDiff(diffData) {
      const container = document.createElement('div');
      container.className = 'diff-container';

      // Header
      const header = document.createElement('div');
      header.className = 'diff-header';
      header.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
        </svg>
        <span class="diff-file-path">${diffData.filePath || 'Unknown'}</span>
      `;

      // Content
      const content = document.createElement('div');
      content.className = 'diff-content';

      if (diffData.lines && Array.isArray(diffData.lines)) {
        diffData.lines.forEach(line => {
          const lineDiv = document.createElement('div');
          lineDiv.className = `diff-line ${line.type}`;

          const lineNumber = document.createElement('div');
          lineNumber.className = 'diff-line-number';
          lineNumber.textContent = line.number || '';

          const lineContent = document.createElement('div');
          lineContent.className = 'diff-line-content';
          lineContent.textContent = line.content || '';

          lineDiv.appendChild(lineNumber);
          lineDiv.appendChild(lineContent);
          content.appendChild(lineDiv);
        });
      } else if (diffData.diff) {
        // Parse unified diff format
        const lines = diffData.diff.split('\n');
        lines.forEach(line => {
          const lineDiv = document.createElement('div');
          lineDiv.className = 'diff-line';

          const lineContent = document.createElement('div');
          lineContent.className = 'diff-line-content';
          lineContent.style.paddingLeft = '12px';

          if (line.startsWith('@@')) {
            lineDiv.classList.add('diff-hunk');
            lineContent.textContent = line;
          } else if (line.startsWith('+')) {
            lineDiv.classList.add('diff-add');
            lineContent.textContent = line;
          } else if (line.startsWith('-')) {
            lineDiv.classList.add('diff-remove');
            lineContent.textContent = line;
          } else {
            lineDiv.classList.add('diff-context');
            lineContent.textContent = line;
          }

          lineDiv.appendChild(lineContent);
          content.appendChild(lineDiv);
        });
      }

      container.appendChild(header);
      container.appendChild(content);

      return container;
    }

    /**
     * æ¸²æŸ“ä»£ç å—
     */
    function renderCodeBlock(code, language = '') {
      const block = document.createElement('div');
      block.className = 'code-block';

      // Header
      const header = document.createElement('div');
      header.className = 'code-header';
      header.innerHTML = `
        <span class="code-lang">${language || 'text'}</span>
        <button class="copy-btn text-xs hover:text-white transition-colors" onclick="copyCode(this)">
          <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
        </button>
      `;

      // Content
      const content = document.createElement('div');
      content.className = 'code-content';

      const pre = document.createElement('pre');
      const codeEl = document.createElement('code');
      codeEl.className = `language-${language || 'text'}`;
      codeEl.textContent = code;

      pre.appendChild(codeEl);
      content.appendChild(pre);

      block.appendChild(header);
      block.appendChild(content);

      // Apply syntax highlighting
      block.addEventListener('click', () => {
        hljs.highlightElement(codeEl);
      });

      return block;
    }

    /**
     * æ ¼å¼åŒ–å·¥å…·å‚æ•°
     */
    function formatToolParams(params) {
      if (!params || typeof params !== 'object') {
        return '';
      }

      let html = '';
      for (const [key, value] of Object.entries(params)) {
        const formattedValue = formatValue(value);
        html += `<div><span class="tool-param-key">${key}</span>: ${formattedValue}</div>`;
      }
      return html;
    }

    /**
     * æ ¼å¼åŒ–å€¼
     */
    function formatValue(value) {
      if (typeof value === 'string') {
        return `<span class="tool-param-string">"${escapeHtml(value)}"</span>`;
      } else if (typeof value === 'number') {
        return `<span class="tool-param-number">${value}</span>`;
      } else if (typeof value === 'boolean') {
        return value ? '<span class="tool-param-string">true</span>' : '<span class="tool-param-string">false</span>';
      } else if (Array.isArray(value)) {
        return `[${value.map(v => formatValue(v)).join(', ')}]`;
      } else if (typeof value === 'object' && value !== null) {
        let obj = '{ ';
        for (const [k, v] of Object.entries(value)) {
          obj += `<span class="tool-param-key">${k}</span>: ${formatValue(v)}, `;
        }
        return obj.slice(0, -2) + ' }';
      }
      return String(value);
    }

    /**
     * è·å–å·¥å…·å›¾æ ‡
     */
    function getToolIcon(toolName) {
      const icons = {
        'Bash': '$',
        'Edit': 'âœ',
        'Read': 'ğŸ“–',
        'Write': 'ğŸ“',
        'Grep': 'ğŸ”',
        'Glob': 'ğŸ“',
        'Task': 'ğŸ¤–',
        'AskUserQuestion': 'â“',
        'WebSearch': 'ğŸŒ',
        'mcp__4_5v_mcp__analyze_image': 'ğŸ–¼',
        'mcp__milk_tea_server__claim_milk_tea_coupon': 'ğŸ§‹',
        'mcp__web_reader__webReader': 'ğŸ“„',
      };
      return icons[toolName] || 'ğŸ”§';
    }

    /**
     * åˆ¤æ–­æ˜¯å¦æ˜¯ç»ˆç«¯è¾“å‡º
     */
    function isTerminalOutput(content) {
      if (!content || typeof content !== 'string') return false;
      const terminalIndicators = ['$', '>', 'error:', 'warning:', 'npm ', 'pip ', 'git '];
      return terminalIndicators.some(indicator => content.toLowerCase().includes(indicator));
    }

    /**
     * HTML è½¬ä¹‰
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * å¤åˆ¶ä»£ç 
     */
    function copyCode(button) {
      const codeBlock = button.closest('.code-block');
      const code = codeBlock.querySelector('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        button.textContent = 'å·²å¤åˆ¶!';
        setTimeout(() => {
          button.innerHTML = `
            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          `;
        }, 2000);
      });
    }
    window.copyCode = copyCode;

    /**
     * æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
     */
    function formatMessageContent(content) {
      if (!content) return '';

      const container = document.createElement('div');
      container.className = 'message-content';

      // å¤„ç†å­—ç¬¦ä¸²å†…å®¹
      if (typeof content === 'string') {
        // è§£æä»£ç å—
        const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
        let lastIndex = 0;
        let match;

        while ((match = codeBlockRegex.exec(content)) !== null) {
          // æ·»åŠ ä»£ç å—å‰çš„æ–‡æœ¬
          const textBefore = content.substring(lastIndex, match.index);
          if (textBefore.trim()) {
            container.innerHTML += formatInlineText(textBefore);
          }

          // æ·»åŠ ä»£ç å—
          const language = match[1] || '';
          const code = match[2];
          container.appendChild(renderCodeBlock(code, language));

          lastIndex = match.index + match[0].length;
        }

        // æ·»åŠ å‰©ä½™æ–‡æœ¬
        const textAfter = content.substring(lastIndex);
        if (textAfter.trim()) {
          container.innerHTML += formatInlineText(textAfter);
        }
      } else if (Array.isArray(content)) {
        // å¤„ç†å†…å®¹æ•°ç»„ï¼ˆtool_use, textç­‰ï¼‰
        content.forEach(item => {
          if (item.type === 'text') {
            const textDiv = document.createElement('div');
            textDiv.innerHTML = formatInlineText(item.text);
            container.appendChild(textDiv);
          } else if (item.type === 'tool_use') {
            container.appendChild(renderToolUse(item));
          } else if (item.type === 'tool_result') {
            container.appendChild(renderToolResult(item));
          }
        });
      }

      return container;
    }

    /**
     * æ ¼å¼åŒ–å†…è”æ–‡æœ¬
     */
    function formatInlineText(text) {
      return text
        .replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>')
        .split('\n\n')
        .map(p => p.trim() ? `<p>${p.replace(/\n/g, '<br>')}</p>` : '')
        .join('');
    }

    // ==================== ä¸»è¦åŠŸèƒ½å‡½æ•° ====================

    // ==================== é¡¹ç›®ç®¡ç†å‡½æ•° ====================

    // åŠ è½½é¡¹ç›®åˆ—è¡¨
    async function loadProjectsList() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();
        state.projectsList = data.projects || [];
        renderProjectSelector();
      } catch (error) {
        console.error('[Client] Failed to load projects:', error);
      }
    }

    // æ¸²æŸ“é¡¹ç›®é€‰æ‹©å™¨
    function renderProjectSelector() {
      projectSelector.innerHTML = '<option value="">æ— é¡¹ç›®</option>';
      state.projectsList.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        if (project.id === state.currentProjectId) {
          option.selected = true;
        }
        projectSelector.appendChild(option);
      });
    }

    // åˆ‡æ¢é¡¹ç›®
    async function switchProject(projectId) {
      console.log('[Client] Switching project to:', projectId);

      state.currentProjectId = projectId ? parseInt(projectId) : null;

      // ä¿å­˜åˆ° localStorage
      localStorage.setItem('currentProjectId', projectId || '');

      // ç­‰å¾…é”é‡Šæ”¾ï¼ˆå¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼‰
      while (state.connectingLock) {
        console.log('[Client] Waiting for connecting lock to release...');
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // è®¾ç½®é”ï¼Œé˜²æ­¢æ–°è¿æ¥
      state.connectingLock = true;

      // åˆ‡æ¢é¡¹ç›®æ—¶ï¼Œå…³é—­å½“å‰ä¼šè¯
      if (state.eventSource) {
        console.log('[Client] Closing old SSE connection...');
        state.eventSource.close();
        state.eventSource = null;

        // ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
        await new Promise(resolve => setTimeout(resolve, 200));
      }

      // é‡ç½®ä¼šè¯ID
      state.sessionId = null;

      // é‡Šæ”¾é”
      state.connectingLock = false;

      // æ¸…ç©ºèŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºæ¬¢è¿ç•Œé¢ï¼ˆä¸åˆ›å»ºæ–°ä¼šè¯ï¼‰
      chatContainer.innerHTML = `
        <div class="welcome-message flex flex-col items-center justify-center h-full text-center animate-fadeIn">
          <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-6 shadow-lg shadow-orange-900/30">
            CC
          </div>
          <h2 class="text-2xl font-bold text-gray-100 mb-2">æ¬¢è¿ä½¿ç”¨ Claude Code</h2>
          <p class="text-gray-400 mb-1">ç‹¬ç«‹è¿è¡Œçš„ AI ç¼–ç¨‹åŠ©æ‰‹</p>
          <p class="text-sm text-gray-500 mt-4">å·²åˆ‡æ¢åˆ°é¡¹ç›®: ${state.currentProjectId ? state.projectsList.find(p => p.id === state.currentProjectId)?.name : 'æ— é¡¹ç›®'}</p>
          <p class="text-xs text-gray-600 mt-2">ç‚¹å‡»"æ–°å¯¹è¯"å¼€å§‹å·¥ä½œ</p>
        </div>
      `;

      // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰æ–°é¡¹ç›®è¿‡æ»¤ï¼‰
      await loadSessionsList();

      // å¦‚æœè¯¥é¡¹ç›®æœ‰ä¼šè¯ï¼Œè‡ªåŠ¨æ‰“å¼€ç¬¬ä¸€ä¸ªï¼ˆæœ€æ–°çš„ï¼‰
      if (state.sessionsList.length > 0) {
        const firstSession = state.sessionsList[0];
        console.log('[Client] Auto-opening first session:', firstSession.id);
        await switchToSession(firstSession.id);
      }

      console.log('[Client] Switched to project:', projectId);
    }

    // åˆ›å»ºæ–°é¡¹ç›®
    async function createProject() {
      const name = prompt('è¯·è¾“å…¥é¡¹ç›®åç§°:');
      if (!name) return;

      // è·¯å¾„è¾“å…¥æç¤º
      alert('è¯·åœ¨ä¸‹ä¸€è¡Œè¾“å…¥é¡¹ç›®çš„å·¥ä½œç›®å½•è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰:\nä¾‹å¦‚: /home/user/my-project æˆ– C:\\Projects\\MyProject');

      const projectPath = prompt('è¯·è¾“å…¥é¡¹ç›®çš„å·¥ä½œç›®å½•è·¯å¾„:');
      if (!projectPath) return;

      try {
        const response = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, path: projectPath })
        });

        if (response.ok) {
          const project = await response.json();
          console.log('[Client] Created project:', project);
          await loadProjectsList();
          projectSelector.value = project.id;
          await switchProject(project.id); // åˆ‡æ¢åˆ°æ–°é¡¹ç›®ï¼ˆä½†ä¸åˆ›å»ºä¼šè¯ï¼‰
          alert(`é¡¹ç›® "${name}" åˆ›å»ºæˆåŠŸï¼`);
        } else {
          const error = await response.json();
          showError('åˆ›å»ºé¡¹ç›®å¤±è´¥: ' + error.error);
        }
      } catch (error) {
        console.error('[Client] Failed to create project:', error);
        showError('åˆ›å»ºé¡¹ç›®å¤±è´¥: ' + error.message);
      }
    }

    // ç®¡ç†é¡¹ç›®ï¼ˆæ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨å¹¶å…è®¸åˆ é™¤ï¼‰
    async function manageProjects() {
      if (state.projectsList.length === 0) {
        alert('æš‚æ— é¡¹ç›®ã€‚è¯·å…ˆåˆ›å»ºé¡¹ç›®ã€‚');
        return;
      }

      let message = 'é¡¹ç›®ç®¡ç†:\n\n';
      state.projectsList.forEach(p => {
        message += `${p.id}. ${p.name}\n   è·¯å¾„: ${p.path}\n\n`;
      });
      message += 'è¾“å…¥é¡¹ç›®IDè¿›è¡Œåˆ é™¤ï¼Œæˆ–ç‚¹å‡»å–æ¶ˆå…³é—­ã€‚';

      const action = prompt(message);
      if (!action) return;

      const projectId = parseInt(action);
      const project = state.projectsList.find(p => p.id === projectId);
      if (!project) {
        showError('é¡¹ç›®IDä¸å­˜åœ¨');
        return;
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${project.name}" å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`/api/projects/${projectId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          console.log('[Client] Deleted project:', projectId);
          await loadProjectsList();

          // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¡¹ç›®ï¼Œåˆ‡æ¢åˆ°æ— é¡¹ç›®
          if (state.currentProjectId === projectId) {
            projectSelector.value = '';
            switchProject(null);
          }

          alert('é¡¹ç›®å·²åˆ é™¤');
        } else {
          showError('åˆ é™¤é¡¹ç›®å¤±è´¥');
        }
      } catch (error) {
        console.error('[Client] Failed to delete project:', error);
        showError('åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message);
      }
    }

    // ==================== ä¼šè¯ç®¡ç†å‡½æ•° ====================

    // åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰é¡¹ç›®è¿‡æ»¤ï¼‰
    async function loadSessionsList() {
      try {
        // æ ¹æ®å½“å‰é¡¹ç›®è¿‡æ»¤ä¼šè¯
        const url = state.currentProjectId
          ? `/api/sessions?project=${state.currentProjectId}`
          : '/api/sessions';

        const response = await fetch(url);
        const data = await response.json();
        state.sessionsList = data.sessions;
        renderSessionsList();
      } catch (error) {
        console.error('[Client] Failed to load sessions list:', error);
      }
    }

    // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
    function renderSessionsList() {
      sessionsListEl.innerHTML = '';

      // æ›´æ–°é¡¹ç›®æ ‡é¢˜
      const projectTitle = document.getElementById('project-title');
      if (state.currentProjectId) {
        const project = state.projectsList.find(p => p.id === state.currentProjectId);
        if (project) {
          projectTitle.innerHTML = `
            <div class="text-xs text-gray-500 font-medium">
              ${project.name}
              <span class="ml-2 text-gray-600">(${state.sessionsList.length} ä¸ªä¼šè¯)</span>
            </div>
          `;
        }
      } else {
        projectTitle.innerHTML = `
          <div class="text-xs text-gray-500 font-medium">
            å…¨éƒ¨é¡¹ç›®
            <span class="ml-2 text-gray-600">(${state.sessionsList.length} ä¸ªä¼šè¯)</span>
          </div>
        `;
      }

      if (state.sessionsList.length === 0) {
        const emptyText = state.currentProjectId
          ? 'è¯¥é¡¹ç›®æš‚æ— ä¼šè¯å†å²'
          : 'æš‚æ— ä¼šè¯å†å²';
        sessionsListEl.innerHTML = `<div class="text-center text-gray-500 text-sm py-8">${emptyText}</div>`;
        return;
      }

      state.sessionsList.forEach((session, index) => {
        const sessionItem = document.createElement('div');
        sessionItem.className = `session-item group flex items-center gap-2 p-3 rounded-lg cursor-pointer ${
          session.id === state.sessionId
            ? 'bg-blue-600/20 text-blue-400'
            : 'hover:bg-gray-800 text-gray-300'
        } animate-fadeIn-staggered-${Math.min(index + 1, 3)}`;

        const sessionContent = document.createElement('div');
        sessionContent.className = 'flex-1 min-w-0 cursor-pointer';
        sessionContent.onclick = () => switchToSession(session.id);

        const date = new Date(session.updatedAt);
        const timeStr = date.toLocaleString('zh-CN', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        sessionContent.innerHTML = `
          <div class="font-medium text-sm truncate">ä¼šè¯ #${session.id}</div>
          <div class="text-xs text-gray-500 truncate">${session.messageCount} æ¡æ¶ˆæ¯ Â· ${timeStr}</div>
        `;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'opacity-0 group-hover:opacity-100 p-1.5 hover:bg-red-900/50 rounded-lg text-gray-400 hover:text-red-400 transition-all duration-200';
        deleteBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        `;
        deleteBtn.onclick = async (e) => {
          e.stopPropagation();
          await deleteSession(session.id);
        };

        sessionItem.appendChild(sessionContent);
        sessionItem.appendChild(deleteBtn);
        sessionsListEl.appendChild(sessionItem);
      });
    }

    // åŠ è½½æ›´å¤šæ¶ˆæ¯ï¼ˆåˆ†é¡µï¼‰
    async function loadMoreMessages(sessionId, offset, button) {
      button.disabled = true;
      button.textContent = 'åŠ è½½ä¸­...';

      try {
        const response = await fetch(`/api/sessions/${sessionId}?limit=50&offset=${offset}`);
        const data = await response.json();

        if (data.messages && data.messages.length > 0) {
          const fragment = document.createDocumentFragment();

          // å€’åºæ’å…¥ï¼ˆæ—§æ¶ˆæ¯åœ¨ä¸Šé¢ï¼‰
          data.messages.slice().reverse().forEach((msg, index) => {
            const messageDiv = createMessageElement(msg, -1); // ä¸ä½¿ç”¨åŠ¨ç”»
            if (messageDiv) {
              fragment.appendChild(messageDiv);
            }
          });

          // æ’å…¥åˆ°æŒ‰é’®å‰é¢
          button.after(fragment);

          if (data.hasMore) {
            button.disabled = false;
            button.textContent = `åŠ è½½æ›´å¤šæ¶ˆæ¯ (è¿˜æœ‰ ${data.total - (offset + data.limit)} æ¡)`;
            button.onclick = () => loadMoreMessages(sessionId, offset + data.limit, button);
          } else {
            button.remove(); // æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†ï¼Œç§»é™¤æŒ‰é’®
          }
        }
      } catch (error) {
        console.error('[Client] Failed to load more messages:', error);
        button.textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
        button.disabled = false;
      }
    }

    // åˆ é™¤ä¼šè¯
    async function deleteSession(sessionId) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯ #${sessionId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
        return;
      }

      try {
        const response = await fetch(`/api/sessions/${sessionId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          console.log('[Client] Deleted session:', sessionId);

          if (state.sessionId === sessionId) {
            chatContainer.innerHTML = `
              <div class="welcome-message flex flex-col items-center justify-center h-full text-center animate-fadeIn">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-6 shadow-lg shadow-orange-900/30">
                  CC
                </div>
                <h2 class="text-2xl font-bold text-gray-100 mb-2">æ¬¢è¿ä½¿ç”¨ Claude Code</h2>
                <p class="text-gray-400">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
              </div>
            `;
            state.sessionId = null;
            state.connected = false;
            state.connectingLock = false; // é‡Šæ”¾é”
            updateStatus(false);

            if (state.eventSource) {
              state.eventSource.close();
              state.eventSource = null;
            }

            localStorage.removeItem('lastSessionId');
          }

          await loadSessionsList();
        } else {
          showError('åˆ é™¤ä¼šè¯å¤±è´¥');
        }
      } catch (error) {
        console.error('[Client] Failed to delete session:', error);
        showError('åˆ é™¤ä¼šè¯å¤±è´¥: ' + error.message);
      }
    }

    // åˆ‡æ¢åˆ°ç°æœ‰ä¼šè¯ï¼ˆä¼˜åŒ–ï¼šåªåŠ è½½æœ€è¿‘ 50 æ¡æ¶ˆæ¯ï¼‰
    async function switchToSession(sessionId) {
      console.log('[Client] Switching to session:', sessionId);

      // ç­‰å¾…é”é‡Šæ”¾
      while (state.connectingLock) {
        console.log('[Client] Waiting for connecting lock to release...');
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      chatContainer.style.transition = 'opacity 0.05s ease';
      chatContainer.style.opacity = '0';

      setTimeout(async () => {
        chatContainer.innerHTML = '';

        try {
          // åªåŠ è½½æœ€è¿‘ 50 æ¡æ¶ˆæ¯
          const response = await fetch(`/api/sessions/${sessionId}?limit=50&offset=0`);
          const data = await response.json();

          if (data.messages && data.messages.length > 0) {
            // ä½¿ç”¨ DocumentFragment æ‰¹é‡æ¸²æŸ“
            const fragment = document.createDocumentFragment();

            // åªå¯¹å‰ 5 æ¡æ¶ˆæ¯ä½¿ç”¨åŠ¨ç”»
            data.messages.forEach((msg, index) => {
              const messageDiv = createMessageElement(msg, Math.min(index, 5));
              if (messageDiv) {
                // åªå¯¹å‰ 5 æ¡åº”ç”¨å»¶è¿ŸåŠ¨ç”»
                if (index < 5) {
                  messageDiv.style.animationDelay = `${index * 20}ms`;
                }
                fragment.appendChild(messageDiv);
              }
            });

            chatContainer.appendChild(fragment);

            // å¦‚æœè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
            if (data.hasMore) {
              const loadMoreBtn = document.createElement('button');
              loadMoreBtn.className = 'block mx-auto mt-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm rounded-lg transition-colors';
              loadMoreBtn.textContent = `åŠ è½½æ›´å¤šæ¶ˆæ¯ (è¿˜æœ‰ ${data.total - data.limit} æ¡)`;
              loadMoreBtn.onclick = () => loadMoreMessages(sessionId, data.offset + data.limit, loadMoreBtn);
              chatContainer.insertBefore(loadMoreBtn, chatContainer.firstChild);
            }

            // ç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨
            requestAnimationFrame(() => {
              chatContainer.scrollTop = chatContainer.scrollHeight;
            });
          }

          // è®¾ç½®é”
          state.connectingLock = true;

          // å…³é—­æ—§çš„ SSE è¿æ¥
          if (state.eventSource) {
            console.log('[Client] Closing old SSE connection...');
            state.eventSource.close();
            state.eventSource = null;

            // ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          connectSSE(sessionId);

          chatContainer.style.opacity = '1';

          await loadSessionsList();
        } catch (error) {
          console.error('[Client] Failed to load session:', error);
          showError('åŠ è½½ä¼šè¯å¤±è´¥: ' + error.message);
          chatContainer.style.opacity = '1';
          state.connectingLock = false;
        }
      }, 100);
    }

    /**
     * åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼ˆæ”¯æŒ VSCode-style æ¸²æŸ“ï¼‰
     */
    function createMessageElement(msg, index = 0) {
      const messageDiv = document.createElement('div');

      // åªå¯¹å‰ 10 æ¡æ¶ˆæ¯ä½¿ç”¨ staggered åŠ¨ç”»
      if (index < 10) {
        messageDiv.style.opacity = '0';
        messageDiv.style.animationDelay = `${index * 30}ms`;
        const animClass = msg.role === 'user' ? 'message-user' : 'message-assistant';
        messageDiv.classList.add(animClass);
      }

      messageDiv.className = `flex gap-3 max-w-4xl mx-auto animate-fadeIn ${msg.role === 'user' ? 'flex-row-reverse' : ''}`;

      const avatar = document.createElement('div');
      avatar.className = `w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold flex-shrink-0 shadow-lg ${
        msg.role === 'user'
          ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white'
          : 'bg-gradient-to-br from-orange-500 to-red-600 text-white'
      }`;
      avatar.textContent = msg.role === 'user' ? 'U' : 'C';

      const contentDiv = document.createElement('div');
      contentDiv.className = `message-content flex-1 px-4 py-3 rounded-2xl ${
        msg.role === 'user'
          ? 'bg-blue-600 text-white'
          : 'bg-transparent text-gray-200'
      }`;

      // æ ¹æ®è§’è‰²æ¸²æŸ“å†…å®¹
      if (msg.role === 'user') {
        let content = '';
        if (typeof msg.content === 'string') {
          content = msg.content;
        } else if (msg.message?.content) {
          content = msg.message.content;
        }
        contentDiv.innerHTML = formatInlineText(content);
      } else if (msg.role === 'assistant') {
        // ä½¿ç”¨ VSCode-style æ¸²æŸ“
        const formattedContent = formatMessageContent(msg.content);
        contentDiv.appendChild(formattedContent);
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);

      return messageDiv;
    }

    // åˆ›å»ºæ–°ä¼šè¯
    async function createNewSession() {
      // ç­‰å¾…é”é‡Šæ”¾ï¼ˆå¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼‰
      while (state.connectingLock) {
        console.log('[Client] Waiting for connecting lock to release...');
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // è®¾ç½®é”
      state.connectingLock = true;

      try {
        const response = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId: state.currentProjectId })
        });
        const data = await response.json();

        console.log('[Client] Created new session:', data.id);
        chatContainer.innerHTML = '';

        // å…³é—­æ—§çš„ SSE è¿æ¥
        if (state.eventSource) {
          console.log('[Client] Closing old SSE connection...');
          state.eventSource.close();
          state.eventSource = null;

          // ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        // é‡ç½®ä¼šè¯ID
        state.sessionId = null;

        connectSSE(data.id);
        await loadSessionsList(); // åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆè‡ªåŠ¨æŒ‰é¡¹ç›®è¿‡æ»¤ï¼‰
      } catch (error) {
        console.error('[Client] Failed to create session:', error);
        showError('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
        state.connectingLock = false;
      }
    }

    // æ£€æŸ¥é…ç½®çŠ¶æ€
    async function checkConfig() {
      try {
        const response = await fetch('/api/config');
        const data = await response.json();

        state.apiKeyConfigured = data.api_key_configured;
        state.baseUrl = data.base_url;
        state.configLoaded = true;

        if (state.apiKeyConfigured) {
          if (state.baseUrl.includes('bigmodel.cn')) {
            configProvider.textContent = 'æ™ºè°±AI (bigmodel.cn)';
          } else if (state.baseUrl.includes('api.anthropic.com')) {
            configProvider.textContent = 'Anthropic å®˜æ–¹';
          } else {
            configProvider.textContent = state.baseUrl;
          }
          configInfo.classList.remove('hidden');
          apiWarning.classList.add('hidden');
        } else {
          apiWarning.classList.remove('hidden');
          configInfo.classList.add('hidden');
        }
      } catch (error) {
        console.error('[Client] Failed to check config:', error);
        apiWarning.classList.remove('hidden');
      }
    }

    function dismissApiWarning() {
      apiWarning.classList.add('hidden');
    }
    window.dismissApiWarning = dismissApiWarning;

    // è¿æ¥ SSE
    function connectSSE(sessionId = null) {
      console.log('[Client] Connecting SSE for session:', sessionId);

      let streamUrl = '/api/stream';
      if (sessionId) {
        streamUrl += `?session=${sessionId}`;
      }
      // æ·»åŠ é¡¹ç›®IDå‚æ•°
      if (state.currentProjectId) {
        streamUrl += `${streamUrl.includes('?') ? '&' : '?'}project=${state.currentProjectId}`;
      }

      state.eventSource = new EventSource(streamUrl);
      setupEventSourceHandlers();
    }

    // è®¾ç½® EventSource äº‹ä»¶å¤„ç†å™¨
    function setupEventSourceHandlers() {
      state.eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('[Client] Received:', data);

          if (data.type === 'connected') {
            state.sessionId = data.sessionId;
            state.connected = true;
            state.connectingLock = false; // é‡Šæ”¾é”
            updateStatus(true);
            localStorage.setItem('lastSessionId', data.sessionId.toString());
            loadSessionsList();

            const welcome = chatContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();
          } else if (data.type === 'claude_output') {
            handleClaudeOutput(data.data);
          } else if (data.type === 'claude_error') {
            showError(data.data);
            state.connectingLock = false; // å‡ºé”™æ—¶ä¹Ÿé‡Šæ”¾é”
          }
        } catch (error) {
          console.error('[Client] Error:', error);
        }
      };

      state.eventSource.onerror = (error) => {
        console.error('[Client] SSE error:', error);
        updateStatus(false);
        state.connectingLock = false; // é”™è¯¯æ—¶é‡Šæ”¾é”
      };

      state.eventSource.onopen = () => {
        console.log('[Client] SSE connected');
        updateStatus(true);
      };
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateStatus(connected) {
      state.connected = connected;
      if (connected) {
        statusDot.classList.remove('bg-red-500');
        statusDot.classList.add('bg-green-500', 'animate-pulse');
        statusText.textContent = 'å·²è¿æ¥';
        statusText.classList.remove('text-red-400');
        statusText.classList.add('text-gray-400');
      } else {
        statusDot.classList.remove('bg-green-500', 'animate-pulse');
        statusDot.classList.add('bg-red-500');
        statusText.textContent = 'è¿æ¥ä¸­...';
        statusText.classList.add('text-red-400');
      }
    }

    // å‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒæ‰“æ–­æœºåˆ¶ï¼‰
    async function sendMessage() {
      const content = messageInput.value.trim();
      if (!content) return;

      // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œå…ˆåˆ›å»ºæ–°ä¼šè¯
      if (!state.sessionId) {
        console.log('[Client] No active session, creating new one...');

        // ç­‰å¾…é”é‡Šæ”¾
        while (state.connectingLock) {
          console.log('[Client] Waiting for connecting lock to release...');
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        await createNewSession();

        // ç­‰å¾…ä¼šè¯å»ºç«‹ï¼ˆæœ€å¤šç­‰å¾… 5 ç§’ï¼‰
        let waited = 0;
        while (!state.sessionId && waited < 5000) {
          await new Promise(resolve => setTimeout(resolve, 100));
          waited += 100;
        }

        // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
        if (!state.sessionId) {
          showError('æ— æ³•åˆ›å»ºä¼šè¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }

        console.log('[Client] Session established:', state.sessionId);
      }

      // æ‰“æ–­æœºåˆ¶ï¼šå¦‚æœå½“å‰æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å®ƒ
      if (state.isTaskRunning) {
        console.log('[Client] Interrupting current task with new message');

        // ç§»é™¤å½“å‰çš„è¾“å…¥æŒ‡ç¤ºå™¨
        const indicators = chatContainer.querySelectorAll('.typing-indicator');
        indicators.forEach(i => i.remove());

        // æ·»åŠ æ‰“æ–­æç¤º
        const interruptNotice = document.createElement('div');
        interruptNotice.className = 'max-w-4xl mx-auto bg-blue-900/30 border border-blue-800 text-blue-300 px-4 py-2 rounded-xl text-sm animate-fadeIn mb-2';
        interruptNotice.innerHTML = `
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span>æ‰“æ–­å½“å‰è¾“å‡ºï¼Œå¤„ç†æ–°æ¶ˆæ¯...</span>
          </div>
        `;
        chatContainer.appendChild(interruptNotice);

        // è°ƒç”¨åœæ­¢ API
        await fetch(`/api/sessions/${state.sessionId}/stop`, {
          method: 'POST'
        }).catch(err => console.log('[Client] Stop API error (expected):', err));

        // 1ç§’åç§»é™¤æç¤º
        setTimeout(() => {
          interruptNotice.remove();
        }, 1000);

        // é‡ç½®æµå¼çŠ¶æ€
        state.currentMessageId = null;
        state.currentTextElement = null;
      }

      addMessage('user', content);
      messageInput.value = '';
      messageInput.style.height = 'auto';
      sendButton.disabled = true;

      // æ˜¾ç¤ºåœæ­¢æŒ‰é’®ï¼Œä»»åŠ¡å¼€å§‹è¿è¡Œ
      setTaskRunning(true);

      const typingIndicator = addTypingIndicator();

      try {
        await fetch('/api/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: state.sessionId,
            message: {
              type: 'user_message',
              content: content
            }
          })
        });
      } catch (error) {
        console.error('[Client] Send error:', error);
        showError('å‘é€å¤±è´¥: ' + error.message);
        removeTypingIndicator(typingIndicator);
        sendButton.disabled = false;
        setTaskRunning(false);
      }
    }

    // è®¾ç½®ä»»åŠ¡è¿è¡ŒçŠ¶æ€ï¼ˆæ˜¾ç¤º/éšè—åœæ­¢æŒ‰é’®ï¼‰
    function setTaskRunning(running) {
      state.isTaskRunning = running;
      if (running) {
        stopButton.classList.remove('hidden');
        sendButton.classList.add('hidden');
        // ä¸è¦ç¦ç”¨è¾“å…¥æ¡†ï¼ç”¨æˆ·éœ€è¦èƒ½å¤Ÿéšæ—¶å‘æ–°æ¶ˆæ¯æ¥æ‰“æ–­
        // messageInput.disabled = true;
      } else {
        stopButton.classList.add('hidden');
        sendButton.classList.remove('hidden');
        sendButton.disabled = false;
        messageInput.disabled = false;
      }
    }

    // åœæ­¢å½“å‰ä»»åŠ¡
    async function stopTask() {
      if (!state.sessionId) return;

      try {
        const response = await fetch(`/api/sessions/${state.sessionId}/stop`, {
          method: 'POST'
        });

        if (response.ok) {
          console.log('[Client] Task stopped');

          // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
          const indicators = chatContainer.querySelectorAll('.typing-indicator');
          indicators.forEach(i => i.remove());

          // æ·»åŠ åœæ­¢æç¤º
          const stopNotice = document.createElement('div');
          stopNotice.className = 'max-w-4xl mx-auto bg-yellow-900/30 border border-yellow-800 text-yellow-300 px-4 py-3 rounded-xl animate-fadeIn';
          stopNotice.textContent = 'âš ï¸ ä»»åŠ¡å·²åœæ­¢';
          chatContainer.appendChild(stopNotice);
          scrollToBottom();

          // 3ç§’åç§»é™¤æç¤º
          setTimeout(() => {
            stopNotice.remove();
          }, 3000);

          setTaskRunning(false);
        } else {
          showError('åœæ­¢ä»»åŠ¡å¤±è´¥');
        }
      } catch (error) {
        console.error('[Client] Stop error:', error);
        showError('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message);
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
    function addMessage(role, content, animationClass = null) {
      const welcome = chatContainer.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      const messageDiv = document.createElement('div');

      let animClass = animationClass;
      if (!animClass) {
        animClass = role === 'user' ? 'message-user' : 'message-assistant';
      }

      messageDiv.className = `flex gap-3 max-w-4xl mx-auto ${animClass} ${role === 'user' ? 'flex-row-reverse' : ''}`;

      const avatar = document.createElement('div');
      avatar.className = `w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold flex-shrink-0 shadow-lg ${
        role === 'user'
          ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white'
          : 'bg-gradient-to-br from-orange-500 to-red-600 text-white'
      }`;
      avatar.textContent = role === 'user' ? 'U' : 'C';

      const contentDiv = document.createElement('div');
      contentDiv.className = `message-content flex-1 px-4 py-3 rounded-2xl ${
        role === 'user'
          ? 'bg-blue-600 text-white'
          : 'bg-transparent text-gray-200'
      }`;

      if (role === 'user') {
        contentDiv.innerHTML = formatInlineText(content);
      } else {
        const formattedContent = formatMessageContent(content);
        contentDiv.appendChild(formattedContent);
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);

      chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
      });

      return contentDiv;
    }

    // æ ¼å¼åŒ–å†…è”æ–‡æœ¬
    function formatInlineText(text) {
      if (typeof text !== 'string') {
        text = String(text);
      }
      return text
        .replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>')
        .split('\n\n')
        .map(p => p.trim() ? `<p>${p.replace(/\n/g, '<br>')}</p>` : '')
        .join('');
    }

    // æ·»åŠ è¾“å…¥æŒ‡ç¤ºå™¨
    function addTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'flex gap-3 max-w-4xl mx-auto message-assistant typing-indicator';
      indicator.innerHTML = `
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 shadow-lg animate-pulse">C</div>
        <div class="message-content flex-1 px-4 py-3 rounded-2xl bg-gray-800">
          <div class="flex gap-1 items-center">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
            <span class="ml-2 text-xs text-gray-500">æ­£åœ¨æ€è€ƒ...</span>
          </div>
        </div>
      `;
      chatContainer.appendChild(indicator);
      scrollToBottom();
      return indicator;
    }

    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
    function removeTypingIndicator(indicator) {
      if (indicator && indicator.parentNode) {
        indicator.remove();
      }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'max-w-4xl mx-auto bg-red-900/30 border border-red-800 text-red-300 px-4 py-3 rounded-xl animate-fadeIn';
      errorDiv.textContent = 'é”™è¯¯: ' + message;
      chatContainer.appendChild(errorDiv);
      scrollToBottom();
    }

    // å¤„ç† Claude è¾“å‡ºï¼ˆæ”¯æŒæµå¼ deltaï¼‰
    function handleClaudeOutput(data) {
      console.log('[Client] Claude output:', data);

      if (data.type === 'assistant') {
        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        const indicators = chatContainer.querySelectorAll('.typing-indicator');
        indicators.forEach(i => i.remove());

        if (data.message) {
          const messageId = data.message.id;
          const delta = data.message.delta;
          const content = data.message.content;

          // å¦‚æœæœ‰ deltaï¼Œè¯´æ˜æ˜¯æµå¼æ›´æ–°
          if (delta) {
            handleStreamingDelta(messageId, delta, content);
          } else if (content) {
            // å®Œæ•´æ¶ˆæ¯
            handleCompleteMessage(messageId, content);
          }
        }
        sendButton.disabled = false;
      } else if (data.type === 'result') {
        // å®Œæˆå½“å‰æ¶ˆæ¯ï¼Œç§»é™¤æµå¼å…‰æ ‡
        if (state.currentTextElement) {
          state.currentTextElement.classList.remove('streaming-text');
        }
        state.currentMessageId = null;
        state.currentTextElement = null;

        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        const indicators = chatContainer.querySelectorAll('.typing-indicator, .flex.gap-3.max-w-4xl.mx-auto .animate-bounce');
        indicators.forEach(i => {
          if (i.closest('.flex.gap-3.max-w-4xl.mx-auto')?.querySelector('.animate-bounce')) {
            i.closest('.flex.gap-3.max-w-4xl.mx-auto').remove();
          }
        });

        // ä»»åŠ¡å®Œæˆï¼Œéšè—åœæ­¢æŒ‰é’®
        setTaskRunning(false);
      }
    }

    /**
     * å¤„ç†æµå¼ delta æ›´æ–°
     */
    function handleStreamingDelta(messageId, delta, content) {
      console.log('[Client] Streaming delta:', { messageId, delta, content });

      // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ¶ˆæ¯
      if (state.currentMessageId !== messageId) {
        state.currentMessageId = messageId;

        // åˆ›å»ºæ–°çš„æ¶ˆæ¯å®¹å™¨
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex gap-3 max-w-4xl mx-auto message-assistant';
        messageDiv.id = `msg-${messageId}`;

        const avatar = document.createElement('div');
        avatar.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 shadow-lg';
        avatar.textContent = 'C';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content flex-1 px-4 py-3 rounded-2xl bg-transparent text-gray-200';
        contentDiv.id = `content-${messageId}`;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);

        state.streamingMessages.set(messageId, { messageDiv, contentDiv, items: [] });

        // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
        const welcome = chatContainer.querySelector('.welcome-message');
        if (welcome) welcome.remove();
      }

      const messageData = state.streamingMessages.get(messageId);
      if (!messageData) return;

      // å¤„ç† delta
      if (delta.type === 'text' && delta.text) {
        // å¦‚æœè¿˜æ²¡æœ‰æ–‡æœ¬å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!state.currentTextElement) {
          state.currentTextElement = document.createElement('div');
          state.currentTextElement.className = 'text-content streaming-text';
          messageData.contentDiv.appendChild(state.currentTextElement);
        }

        // è¿½åŠ æ–‡æœ¬ï¼ˆå®æ—¶æµå¼æ›´æ–°ï¼‰
        const currentText = state.currentTextElement.textContent || '';
        state.currentTextElement.textContent = currentText + delta.text;

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom();
      } else if (delta.type === 'tool_use') {
        // å·¥å…·è°ƒç”¨å¼€å§‹
        const toolCard = renderToolUse(delta);
        messageData.contentDiv.appendChild(toolCard);
        messageData.items.push({ type: 'tool_use', id: delta.id, element: toolCard });
        scrollToBottom();
      } else if (delta.type === 'tool_result') {
        // å·¥å…·ç»“æœ
        const resultCard = renderToolResult(delta);
        messageData.contentDiv.appendChild(resultCard);
        messageData.items.push({ type: 'tool_result', id: delta.tool_use_id, element: resultCard });
        scrollToBottom();
      }
    }

    /**
     * å¤„ç†å®Œæ•´æ¶ˆæ¯
     */
    function handleCompleteMessage(messageId, content) {
      console.log('[Client] Complete message:', { messageId, content });

      if (!Array.isArray(content)) {
        addMessage('assistant', JSON.stringify(content, null, 2));
        return;
      }

      // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
      const welcome = chatContainer.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3 max-w-4xl mx-auto message-assistant';
      messageDiv.id = `msg-${messageId}`;

      const avatar = document.createElement('div');
      avatar.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 shadow-lg';
      avatar.textContent = 'C';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content flex-1 px-4 py-3 rounded-2xl bg-transparent text-gray-200';

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);

      // æ¸²æŸ“æ‰€æœ‰å†…å®¹é¡¹
      content.forEach(item => {
        if (item.type === 'text') {
          const textDiv = document.createElement('div');
          textDiv.className = 'text-content';
          textDiv.innerHTML = formatInlineText(item.text);
          contentDiv.appendChild(textDiv);
        } else if (item.type === 'tool_use') {
          const toolCard = renderToolUse(item);
          contentDiv.appendChild(toolCard);
        } else if (item.type === 'tool_result') {
          const resultCard = renderToolResult(item);
          contentDiv.appendChild(resultCard);
        }
      });

      state.streamingMessages.set(messageId, { messageDiv, contentDiv, items: [] });
      scrollToBottom();
    }

    // è¿½åŠ å·¥å…·å¡ç‰‡åˆ°èŠå¤©
    function appendToolCard(card) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3 max-w-4xl mx-auto message-assistant';

      const avatar = document.createElement('div');
      avatar.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 shadow-lg';
      avatar.textContent = 'C';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'flex-1';
      contentDiv.appendChild(card);

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);

      scrollToBottom();
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
      });
    }

    // äº‹ä»¶ç›‘å¬
    sendButton.addEventListener('click', sendMessage);
    stopButton.addEventListener('click', stopTask);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
    });

    newChatBtn.addEventListener('click', createNewSession);

    // é¡¹ç›®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
    projectSelector.addEventListener('change', (e) => {
      switchProject(e.target.value);
    });

    createProjectBtn.addEventListener('click', createProject);
    manageProjectsBtn.addEventListener('click', manageProjects);

    // åˆå§‹åŒ–
    checkConfig();

    // åŠ è½½é¡¹ç›®åˆ—è¡¨
    loadProjectsList();

    // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„é¡¹ç›®
    const lastProjectId = localStorage.getItem('currentProjectId');
    if (lastProjectId) {
      state.currentProjectId = parseInt(lastProjectId);
      projectSelector.value = lastProjectId;
    }

    const lastSessionId = localStorage.getItem('lastSessionId');

    loadSessionsList().then(() => {
      if (lastSessionId && state.sessionsList.find(s => s.id === parseInt(lastSessionId))) {
        console.log('[Client] Resuming last session:', lastSessionId);
        connectSSE(parseInt(lastSessionId));
      } else {
        connectSSE();
      }
    });

    messageInput.focus();
  </script>
</body>
</html>
